#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <WiFiManager.h>
#include <DHT.h>
#include <ArduinoJson.h>

// === –ü–ò–ù–´ ===
#define DHT_PIN D4        // DHT11 Data
#define DHT_TYPE DHT11
#define PHOTO_PIN A0      // –§–æ—Ç–æ—Ä–µ–∑–∏—Å—Ç–æ—Ä
#define LED1_PIN D1       // LED1
#define LED2_PIN D2       // LED2
#define LED3_PIN D5       // LED3
#define RGB_R_PIN D6      // RGB R
#define RGB_G_PIN D7      // RGB G
#define RGB_B_PIN D8      // RGB B
#define BUZZER_PIN D0     // –ê–∫—Ç–∏–≤–Ω—ã–π –∑—É–º–º–µ—Ä
#define RELAY_PIN D3      // –†–µ–ª–µ (–ª–µ–Ω—Ç–∞)

// === SUPABASE ===
const char* SUPABASE_URL = "https://yndjuqvejwgxostadikf.supabase.co";
const char* SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InluZGp1cXZlandneG9zdGFkaWtmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2MDQzMzAsImV4cCI6MjA4MTE4MDMzMH0.qRzRvFjnKtpoWIOEhsGWsdqgfz0CexO7cZPxZZP6Tus";

DHT dht(DHT_PIN, DHT_TYPE);
WiFiManager wifiManager;

// –¢–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
int led1_val = 0, led2_val = 0, led3_val = 0;
int rgb_r = 0, rgb_g = 0, rgb_b = 0;
bool strip_state = false, buzzer_state = false;
bool manualOff = false;  // true = –ª–µ–Ω—Ç–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é

// –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –ø–æ —Ñ–æ—Ç–æ—Ä–µ–∑–∏—Å—Ç–æ—Ä—É
const int LIGHT_THRESHOLD = 300;  // –ø–æ—Ä–æ–≥ —Ç–µ–º–Ω–æ—Ç—ã (–ø–æ–¥–±–µ—Ä–∏—Ç–µ –ø–æ–¥ –≤–∞—à—É –∫–æ–º–Ω–∞—Ç—É)
const int MIN_DURATION_MS = 10000; // –º–∏–Ω. –≤—Ä–µ–º—è –º–µ–∂–¥—É –∞–≤—Ç–æ-–≤–∫–ª—é—á–µ–Ω–∏—è–º–∏ (10 —Å–µ–∫)

void setup() {
  Serial.begin(115200);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∏–Ω–æ–≤
  pinMode(LED1_PIN, OUTPUT);
  pinMode(LED2_PIN, OUTPUT);
  pinMode(LED3_PIN, OUTPUT);
  pinMode(RGB_R_PIN, OUTPUT);
  pinMode(RGB_G_PIN, OUTPUT);
  pinMode(RGB_B_PIN, OUTPUT);
  pinMode(BUZZER_PIN, OUTPUT);
  pinMode(RELAY_PIN, OUTPUT);
  
  analogWriteRange(255); // PWM 0-255
  
  dht.begin();
  
  // WiFi Manager (—Å–æ–∑–¥–∞—ë—Ç —Ç–æ—á–∫—É –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
  wifiManager.autoConnect("SmartHome_NodeMCU");
  
  Serial.println("‚úÖ NodeMCU –ø–æ–¥–∫–ª—é—á–µ–Ω! IP: " + WiFi.localIP().toString());
  Serial.println("üì° –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É");
  Serial.println("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ –ª–µ–Ω—Ç—ã –ø–æ —Ñ–æ—Ç–æ—Ä–µ–∑–∏—Å—Ç–æ—Ä—É");
}

void loop() {
  // –ß–∏—Ç–∞–µ–º –¥–∞—Ç—á–∏–∫–∏
  float temp_dht = dht.readTemperature();
  float hum_dht = dht.readHumidity();
  int light = analogRead(PHOTO_PIN); // 0-1023 (0=—Ç–µ–º–Ω–æ, 1023=—Å–≤–µ—Ç–ª–æ)
  
  Serial.print("¬∞C –¢–µ–º–ø: "); Serial.print(temp_dht);
  Serial.print("% –í–ª–∞–∂: "); Serial.print(hum_dht);
  Serial.print("–°–≤–µ—Ç: "); Serial.println(light);

  // === –ê–í–¢–û–ú–ê–¢–ò–ö–ê –õ–ï–ù–¢–´ –ü–û –§–û–¢–û–†–ï–ó–ò–°–¢–û–†–£ ===
  static unsigned long lastAutoChange = 0;
  static bool wasDark = false;
  
  if (millis() - lastAutoChange > MIN_DURATION_MS) {
    bool isDark = (light < LIGHT_THRESHOLD);
    
    // –°—Ç–∞–ª–æ —Ç–µ–º–Ω–æ –ò –ª–µ–Ω—Ç–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞ –ò –ù–ï –≤—ã–∫–ª—é—á–µ–Ω–∞ –≤—Ä—É—á–Ω—É—é ‚Üí –í–ö–õ
    if (isDark && !strip_state && !manualOff) {
      strip_state = true;
      lastAutoChange = millis();
      Serial.println("üåô –ê–í–¢–û: –≤–∫–ª—é—á–∞–µ–º –ª–µ–Ω—Ç—É (—Ç–µ–º–Ω–æ)");
    }
    // –°—Ç–∞–ª–æ —Å–≤–µ—Ç–ª–æ –ò –ª–µ–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ ‚Üí –í–´–ö–õ
    else if (!isDark && strip_state) {
      strip_state = false;
      lastAutoChange = millis();
      Serial.println("‚òÄÔ∏è –ê–í–¢–û: –≤—ã–∫–ª—é—á–∞–µ–º –ª–µ–Ω—Ç—É (—Å–≤–µ—Ç–ª–æ)");
    }
    
    wasDark = isDark;
  }

  // === –ü–†–ò–ú–ï–ù–Ø–ï–ú –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
  analogWrite(LED1_PIN, led1_val);
  analogWrite(LED2_PIN, led2_val);
  analogWrite(LED3_PIN, led3_val);
  analogWrite(RGB_R_PIN, rgb_r);
  analogWrite(RGB_G_PIN, rgb_g);
  analogWrite(RGB_B_PIN, rgb_b);
  digitalWrite(BUZZER_PIN, buzzer_state ? HIGH : LOW);
  digitalWrite(RELAY_PIN, strip_state ? HIGH : LOW); // HIGH = —Ä–µ–ª–µ –í–ö–õ

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Supabase
  sendSensorData(temp_dht, hum_dht, light);
  
  // –ß–∏—Ç–∞–µ–º –∫–æ–º–∞–Ω–¥—ã –∏–∑ Supabase
  loadControls();
  
  delay(1000); // –¶–∏–∫–ª –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
}

void sendSensorData(float temp_dht, float hum_dht, int light) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(String(SUPABASE_URL) + "/rest/v1/sensor_data");
    http.addHeader("apikey", SUPABASE_KEY);
    http.addHeader("Authorization", "Bearer " + String(SUPABASE_KEY));
    http.addHeader("Content-Type", "application/json");
    
    DynamicJsonDocument doc(512);
    doc["temperature_dht"] = temp_dht;
    doc["humidity_dht"] = hum_dht;
    doc["light_resistor"] = light;
    doc["led1_brightness"] = led1_val;
    doc["led2_brightness"] = led2_val;
    doc["led3_brightness"] = led3_val;
    doc["rgb_r"] = rgb_r;
    doc["rgb_g"] = rgb_g;
    doc["rgb_b"] = rgb_b;
    doc["strip_state"] = strip_state;
    
    String json;
    serializeJson(doc, json);
    
    int code = http.POST(json);
    if (code == 201) {
      Serial.println("–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Supabase");
    } else {
      Serial.println("‚ùå –û—à–∏–±–∫–∞ Supabase: " + String(code));
    }
    http.end();
  }
}

void loadControls() {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin(String(SUPABASE_URL) + "/rest/v1/controls");
    http.addHeader("apikey", SUPABASE_KEY);
    http.addHeader("Authorization", "Bearer " + String(SUPABASE_KEY));
    
    int code = http.GET();
    if (code == 200) {
      String payload = http.getString();
      DynamicJsonDocument doc(512);
      deserializeJson(doc, payload);
      
      if (doc.size() > 0) {
        led1_val = doc[0]["led1"];
        led2_val = doc[0]["led2"];
        led3_val = doc[0]["led3"];
        rgb_r = doc[0]["rgb_r"];
        rgb_g = doc[0]["rgb_g"];
        rgb_b = doc[0]["rgb_b"];
        bool newStrip = doc[0]["strip"];
        buzzer_state = doc[0]["buzzer"];

        // –õ–û–ì–ò–ö–ê –†–£–ß–ù–û–ì–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø
        if (!newStrip && strip_state) {
          // –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤—ã–∫–ª—é—á–∏–ª–∏, –Ω–æ –ª–µ–Ω—Ç–∞ –±—ã–ª–∞ –≤–∫–ª—é—á–µ–Ω–∞ ‚Üí —Ä—É—á–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ
          manualOff = true;
          Serial.println("üñêÔ∏è –†—É—á–Ω–æ–µ –≤—ã–∫–ª—é—á–µ–Ω–∏–µ –ª–µ–Ω—Ç—ã");
        } 
        else if (newStrip) {
          // –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –≤–∫–ª—é—á–∏–ª–∏ ‚Üí —Ä–∞–∑—Ä–µ—à–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∫—É
          manualOff = false;
          Serial.println("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞");
        }

        strip_state = newStrip;

        Serial.print("üéõÔ∏è LED1:"); Serial.print(led1_val);
        Serial.print(" LED2:"); Serial.print(led2_val);
        Serial.print(" RGB:"); Serial.print(rgb_r); Serial.print(","); Serial.print(rgb_g); Serial.print(","); Serial.println(rgb_b);
      }
    } else {
      Serial.println("‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è controls: " + String(code));
    }
    http.end();
  }
}

